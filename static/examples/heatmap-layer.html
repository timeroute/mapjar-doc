<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Mapjar 热力图层示例</title>
  <style>
    body { margin: 0; padding: 0; overflow: hidden; font-family: Arial, sans-serif; }
    #map { width: 100vw; height: 100vh; }
    #info {
      position: absolute;
      top: 10px;
      left: 10px;
      background: rgba(255,255,255,0.95);
      padding: 12px 15px;
      border-radius: 4px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.3);
      z-index: 1000;
      font-size: 13px;
      line-height: 1.6;
    }
    #info strong { font-size: 15px; }
    #legend {
      position: absolute;
      bottom: 20px;
      right: 20px;
      background: rgba(255,255,255,0.95);
      padding: 12px 15px;
      border-radius: 4px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.3);
      z-index: 1000;
    }
    .legend-gradient {
      width: 200px;
      height: 20px;
      margin: 10px 0;
      background: linear-gradient(to right, 
        #3288bd 0%, 
        #66c2a5 14%, 
        #abdda4 28%, 
        #e6f598 42%, 
        #fee08b 57%, 
        #fdae61 71%, 
        #f46d43 85%, 
        #d53e4f 100%);
      border-radius: 2px;
      border: 1px solid #ccc;
    }
    .legend-labels {
      display: flex;
      justify-content: space-between;
      font-size: 12px;
      color: #666;
    }
    #loading {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(255,255,255,0.95);
      padding: 20px 30px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.3);
      z-index: 2000;
      font-size: 16px;
    }
    .hidden { display: none; }
  </style>
</head>
<body>
  <canvas id="map"></canvas>
  <div id="loading">加载 GFS 全球风速数据...</div>
  <div id="info">
    <strong>全球风速热力图</strong>
    <div style="margin-top: 5px; color: #666;">数据源: NOAA GFS</div>
    <div style="color: #666;">日期: 2016-11-20 00:00 UTC</div>
    <div style="margin-top: 8px;">分辨率: 360×180 (1°)</div>
  </div>
  <div id="legend">
    <strong>风速 (m/s)</strong>
    <div class="legend-gradient"></div>
    <div class="legend-labels">
      <span>0</span>
      <span>15</span>
      <span>30</span>
    </div>
  </div>
  
  <script type="module">
    import { MapEngine, TileLayer, HeatmapLayer } from 'https://unpkg.com/mapjar@latest/dist/mapjar.js';
    
    const engine = new MapEngine('#map', {
      center: [0, 20],
      zoom: 2,
    });
    
    const tileLayer = new TileLayer('base', 'https://tile.openstreetmap.org/{z}/{x}/{y}.png');
    engine.addLayer(tileLayer);
    
    const heatmapLayer = new HeatmapLayer('windspeed', {
      colorRamp: [
        { value: 0.0, color: '#3288bd' },
        { value: 0.14, color: '#66c2a5' },
        { value: 0.28, color: '#abdda4' },
        { value: 0.42, color: '#e6f598' },
        { value: 0.57, color: '#fee08b' },
        { value: 0.71, color: '#fdae61' },
        { value: 0.85, color: '#f46d43' },
        { value: 1.0, color: '#d53e4f' },
      ],
    });
    
    // GFS 数据元信息
    const metadata = {
      source: "http://nomads.ncep.noaa.gov",
      date: "2016-11-20T00:00Z",
      width: 360,
      height: 180,
      uMin: -21.32,
      uMax: 26.8,
      vMin: -21.57,
      vMax: 21.42
    };
    
    // 加载 GFS 风场数据并计算风速
    async function loadWindSpeedData() {
      const imageUrl = 'https://raw.githubusercontent.com/mapbox/webgl-wind/refs/heads/master/demo/wind/2016112000.png';
      
      const img = new Image();
      img.crossOrigin = 'anonymous';
      
      return new Promise((resolve, reject) => {
        img.onload = () => {
          const canvas = document.createElement('canvas');
          canvas.width = metadata.width;
          canvas.height = metadata.height;
          const ctx = canvas.getContext('2d');
          ctx.drawImage(img, 0, 0);
          
          const imageData = ctx.getImageData(0, 0, metadata.width, metadata.height);
          const pixels = imageData.data;
          
          // 解码并计算风速
          const windSpeed = new Float32Array(metadata.width * metadata.height);
          let maxSpeed = 0;
          
          for (let i = 0; i < pixels.length / 4; i++) {
            const r = pixels[i * 4];
            const g = pixels[i * 4 + 1];
            
            // 从 RGB 解码 U 和 V 分量
            const u = (r / 255.0) * (metadata.uMax - metadata.uMin) + metadata.uMin;
            const v = (g / 255.0) * (metadata.vMax - metadata.vMin) + metadata.vMin;
            
            // 计算风速 (速度的模)
            const speed = Math.sqrt(u * u + v * v);
            windSpeed[i] = speed;
            maxSpeed = Math.max(maxSpeed, speed);
          }

          resolve({ windSpeed, maxSpeed });
        };
        
        img.onerror = reject;
        img.src = imageUrl;
      });
    }
    
    // 重投影：从等经纬度网格重采样为适配 Web Mercator 渲染的网格
    function reprojectToMercator(sourceData, sourceWidth, sourceHeight) {
      const targetWidth = sourceWidth;
      const targetHeight = sourceHeight;
      const targetData = new Float32Array(targetWidth * targetHeight);
      
      for (let y = 0; y < targetHeight; y++) {
        for (let x = 0; x < targetWidth; x++) {
          // 目标网格中，y 方向在 Web Mercator 投影空间中均匀分布
          // 需要将其转换回对应的纬度
          const mercatorY = 1.0 - (y / (targetHeight - 1)); // 0 到 1，从南到北
          
          // Web Mercator Y 转纬度
          const latRad = Math.atan(Math.sinh(Math.PI * (1 - 2 * mercatorY)));
          const lat = latRad * 180 / Math.PI;
          
          // 经度保持线性
          const lon = -180 + (x / (targetWidth - 1)) * 360;
          
          // 在源数据（等经纬度网格）中查找对应位置
          const sourceX = ((lon + 180) / 360) * (sourceWidth - 1);
          const sourceY = ((90 - lat) / 180) * (sourceHeight - 1);
          
          // 边界检查
          if (sourceX < 0 || sourceX >= sourceWidth - 1 || 
              sourceY < 0 || sourceY >= sourceHeight - 1) {
            targetData[y * targetWidth + x] = 0;
            continue;
          }
          
          // 双线性插值
          const x0 = Math.floor(sourceX);
          const x1 = Math.ceil(sourceX);
          const y0 = Math.floor(sourceY);
          const y1 = Math.ceil(sourceY);
          
          const fx = sourceX - x0;
          const fy = sourceY - y0;
          
          const v00 = sourceData[y0 * sourceWidth + x0];
          const v10 = sourceData[y0 * sourceWidth + x1];
          const v01 = sourceData[y1 * sourceWidth + x0];
          const v11 = sourceData[y1 * sourceWidth + x1];
          
          const value = (1 - fx) * (1 - fy) * v00 +
                        fx * (1 - fy) * v10 +
                        (1 - fx) * fy * v01 +
                        fx * fy * v11;
          
          targetData[y * targetWidth + x] = value;
        }
      }
      
      return targetData;
    }
    
    // 初始化热力图层
    loadWindSpeedData().then(({ windSpeed, maxSpeed }) => {
      // 重投影数据以适配 Web Mercator 渲染
      const reprojectedData = reprojectToMercator(windSpeed, metadata.width, metadata.height);
      
      heatmapLayer.setData({
        values: reprojectedData,
        width: metadata.width,
        height: metadata.height,
        min: 0,
        max: maxSpeed,
        bounds: {
          minLon: -180,
          minLat: -85,
          maxLon: 180,
          maxLat: 85,
        },
      });
      heatmapLayer.setOpacity(0.5);
      
      engine.addLayer(heatmapLayer);
      
      // 更新图例
      document.querySelector('#legend .legend-labels').innerHTML = `
        <span>0</span>
        <span>${(maxSpeed / 2).toFixed(1)}</span>
        <span>${maxSpeed.toFixed(1)}</span>
      `;
      
      document.getElementById('loading').classList.add('hidden');
    }).catch(error => {
      console.error('加载风速数据失败:', error);
      document.getElementById('loading').textContent = '加载失败，请刷新重试';
    });
  </script>
</body>
</html>
